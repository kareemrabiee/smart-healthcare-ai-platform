{% extends "base.html" %}

{% block title %}
    {% if current_user.role == 'admin' %}
        إرسال رسالة لمريض
    {% else %}
        إرسال رسالة للطبيب
    {% endif %}
{% endblock %}

{% block content %}
<div class="messages-container">
    <div class="messages-header">
        <h1>
            {% if reply_to_message %}
                الرد على رسالة
            {% elif current_user.role == 'admin' %}
                إرسال رسالة لمريض
            {% else %}
                إرسال رسالة للطبيب
            {% endif %}
        </h1>
        <a href="{{ url_for('messages') }}" class="btn-secondary">
            <i class="fas fa-arrow-right"></i>
            العودة إلى الرسائل
        </a>
    </div>

    <div class="send-message-info">
        {% if current_user.role == 'admin' %}
            <p>يمكنك من خلال هذه الصفحة التواصل مباشرة مع المرضى. اختر المريض المناسب، اكتب موضوع واضح للرسالة، واشرح المعلومات والإرشادات التي ترغب في إيصالها للمريض. يمكن للمريض الرد على رسالتك في أقرب وقت.</p>
        {% else %}
            <p>يمكنك من خلال هذه الصفحة التواصل مباشرة مع الطبيب المختص. اختر الطبيب المناسب لحالتك، اكتب موضوع واضح للرسالة، واشرح حالتك بالتفصيل في محتوى الرسالة. سيقوم الطبيب بالرد عليك في أقرب وقت ممكن.</p>
        {% endif %}
    </div>

    {% if reply_to_message %}
    <div class="reply-box">
        <div class="reply-header">
            <h3>الرسالة الأصلية</h3>
            <span>{{ reply_to_message.created_at.strftime('%Y-%m-%d في %H:%M') }}</span>
        </div>
        <div class="reply-content">
            <div class="reply-from">
                <strong>من: </strong>
                {% if reply_to_message.sender.full_name is defined and reply_to_message.sender.full_name %}
                    {{ reply_to_message.sender.full_name }}
                {% else %}
                    {{ reply_to_message.sender.username }}
                {% endif %}
                {% if reply_to_message.sender.specialty is defined and reply_to_message.sender.specialty %}
                    <span class="specialty">({{ reply_to_message.sender.specialty }})</span>
                {% endif %}
            </div>
            <div class="reply-subject">
                <strong>الموضوع: </strong> {{ reply_to_message.subject }}
            </div>
            <div class="reply-text">
                {{ reply_to_message.content|truncate(200, true) }}
                <a href="{{ url_for('view_message', message_id=reply_to_message.id) }}" class="view-full-message">عرض الرسالة كاملة</a>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="send-message-form">
        <form method="POST" action="{{ url_for('send_message') }}">
            <div class="form-group">
                <label for="recipient">
                    {% if current_user.role == 'admin' %}
                        إرسال إلى مريض
                    {% else %}
                        إرسال إلى طبيب
                    {% endif %}
                </label>
                <select id="recipient" name="recipient" class="form-control" required {% if reply_to_user %}disabled{% endif %}>
                    <option value="" disabled {% if not reply_to_user %}selected{% endif %}>
                        {% if current_user.role == 'admin' %}
                            -- اختر المريض --
                        {% else %}
                            -- اختر الطبيب --
                        {% endif %}
                    </option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}" {% if reply_to_user and reply_to_user.id == doctor.id %}selected{% endif %}>
                        {% if doctor.full_name is defined and doctor.full_name %}
                            {{ doctor.full_name }} - 
                        {% endif %}
                        {% if doctor.specialty is defined and doctor.specialty %}
                            {{ doctor.specialty }}
                        {% else %}
                            {{ doctor.username }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
                {% if reply_to_user %}
                <input type="hidden" name="recipient" value="{{ reply_to_user.id }}">
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="subject">الموضوع</label>
                <input type="text" id="subject" name="subject" class="form-control" required 
                       placeholder="أدخل موضوع الرسالة" 
                       value="{% if reply_subject %}{{ reply_subject }}{% endif %}">
            </div>
            
            <div class="form-group">
                <label for="message">نص الرسالة</label>
                <textarea id="message" name="message" class="form-control" rows="6" required
                          placeholder="اكتب رسالتك هنا..."></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    {% if reply_to_message %}
                        إرسال الرد
                    {% else %}
                        إرسال الرسالة
                    {% endif %}
                </button>
                
                <button type="button" class="btn-secondary" onclick="window.location.href='{{ url_for('messages') }}'">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </form>
    </div>
    
    {% if not reply_to_message and current_user.role != 'admin' %}
    <div class="doctors-info">
        <h3>معلومات عن الأطباء</h3>
        <div class="doctors-list">
            {% for doctor in doctors %}
            <div class="doctor-card">
                <div class="doctor-avatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="doctor-details">
                    <h4>{% if doctor.full_name is defined and doctor.full_name %}
                        {{ doctor.full_name }}
                        {% else %}
                        {{ doctor.username }}
                        {% endif %}</h4>
                    <p class="doctor-specialty">
                        {% if doctor.specialty is defined and doctor.specialty %}
                        {{ doctor.specialty }}
                        {% else %}
                        طبيب
                        {% endif %}
                    </p>
                    <p class="doctor-description">
                        {% if doctor.username == 'dr.mohamed' %}
                            استشاري أول طب وجراحة العيون، خبرة أكثر من 15 عامًا في علاج أمراض العيون
                        {% elif doctor.username == 'dr.sara' %}
                            استشاري جراحة العيون وتصحيح النظر، متخصصة في عمليات الليزك والفيمتو ليزك
                        {% elif doctor.username == 'dr.ahmed' %}
                            استشاري أمراض وجراحة شبكية العين، متخصص في علاج اعتلال الشبكية السكري
                        {% elif doctor.username == 'dr.nora' %}
                            استشاري طب وجراحة قرنية العين، خبرة في علاج أمراض القرنية وزراعتها
                        {% elif doctor.username == 'dr.omar' %}
                            استشاري العدسات التصحيحية والنظارات، خبرة في تشخيص مشاكل الإبصار
                        {% else %}
                            طبيب متخصص في طب وجراحة العيون
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .messages-container {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin: 25px auto;
        max-width: 1200px;
        width: 95%;
    }
    
    .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
    }
    
    .messages-header h1 {
        font-size: 24px;
        color: #333;
        margin: 0;
    }
    
    .send-message-info {
        background-color: #e8f5e9;
        border-right: 4px solid #4CAF50;
        padding: 15px 20px;
        margin-bottom: 25px;
        border-radius: 6px;
        color: #2e7d32;
        font-size: 16px;
        line-height: 1.6;
    }
    
    .send-message-info p {
        margin: 0;
    }
    
    /* تصميم صندوق الرد */
    .reply-box {
        margin-bottom: 25px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .reply-header {
        background-color: #f2f2f2;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
    }
    
    .reply-header h3 {
        margin: 0;
        font-size: 16px;
        color: #333;
    }
    
    .reply-header span {
        font-size: 12px;
        color: #777;
    }
    
    .reply-content {
        padding: 15px;
        background-color: #f9f9f9;
    }
    
    .reply-from, .reply-subject {
        margin-bottom: 10px;
        color: #333;
    }
    
    .reply-from .specialty {
        color: #4CAF50;
        font-size: 13px;
    }
    
    .reply-text {
        background-color: #fff;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 4px;
        color: #555;
        position: relative;
        line-height: 1.5;
        margin-top: 10px;
    }
    
    .view-full-message {
        display: inline-block;
        margin-top: 10px;
        color: #4CAF50;
        text-decoration: none;
        font-size: 13px;
        font-weight: bold;
    }
    
    .view-full-message:hover {
        text-decoration: underline;
    }
    
    .send-message-form {
        padding: 25px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 25px;
        border: 1px solid #eee;
        max-width: 100%;
        width: 100%;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #333;
        font-size: 16px;
    }
    
    .form-control {
        width: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.2s ease;
    }
    
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 180px;
    }
    
    select.form-control {
        background-color: white;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: left 15px center;
        padding-left: 40px;
        height: 50px;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-start;
        gap: 15px;
        margin-top: 30px;
    }
    
    .btn-primary, .btn-secondary {
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 6px;
    }
    
    .btn-primary {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
    }
    
    .btn-primary:hover {
        background-color: #388E3C;
    }
    
    .btn-secondary {
        background-color: #f2f2f2;
        color: #333;
        border: 1px solid #ddd;
        cursor: pointer;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: background-color 0.2s ease;
    }
    
    .btn-secondary:hover {
        background-color: #e6e6e6;
    }
    
    /* معلومات الأطباء */
    .doctors-info {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #eee;
    }
    
    .doctors-info h3 {
        margin-bottom: 25px;
        font-size: 20px;
        color: #333;
        position: relative;
        padding-right: 18px;
    }
    
    .doctors-info h3:before {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 5px;
        height: 22px;
        background-color: #4CAF50;
        border-radius: 3px;
    }
    
    .doctors-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
    }
    
    .doctor-card {
        display: flex;
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #eee;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .doctor-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border-color: #4CAF50;
    }
    
    .doctor-avatar {
        width: 80px;
        height: 80px;
        background-color: #e8f5e9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 20px;
        flex-shrink: 0;
        border: 2px solid #4CAF50;
    }
    
    .doctor-avatar i {
        font-size: 32px;
        color: #4CAF50;
    }
    
    .doctor-details h4 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 18px;
    }
    
    .doctor-specialty {
        color: #4CAF50;
        font-weight: bold;
        margin: 0 0 12px 0;
        font-size: 15px;
        background-color: #e8f5e9;
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
    }
    
    .doctor-description {
        margin: 0;
        font-size: 14px;
        color: #666;
        line-height: 1.6;
    }
    
    /* تنسيق توافقي مع الاتجاه من اليمين إلى اليسار */
    .form-group label, .form-control {
        text-align: right;
    }
    
    /* تحسينات للشاشات الصغيرة */
    @media (max-width: 768px) {
        .messages-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .doctors-list {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %} 